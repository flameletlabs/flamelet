{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Flamelet","text":"<p>Flamelet is a bash-based DevOps tool that wraps Ansible with multi-tenant support, virtual environment isolation, and remote execution. It lets you manage infrastructure across multiple projects and environments from a single installation.</p> <p>Each tenant is a self-contained directory with its own configuration, inventory, playbook, and isolated Python virtual environment. You can switch between tenants with a single flag (<code>-t</code>), and run playbooks locally or remotely via an SSH controller.</p>"},{"location":"#use-cases","title":"Use Cases","text":"<ul> <li>Local provisioning \u2014 Configure the machine flamelet is running on (packages, users, services, config files)</li> <li>Remote provisioning \u2014 Run playbooks on remote infrastructure via an SSH controller, without installing Ansible on every target</li> <li>Multi-OS fleet management \u2014 Manage mixed fleets of Linux (Debian, RedHat), FreeBSD, and OpenBSD hosts from one tool</li> <li>Air-gapped environments \u2014 Operate in offline mode with pre-cached repos and venvs</li> </ul>"},{"location":"#prerequisites","title":"Prerequisites","text":"<ul> <li>A Unix-like operating system: macOS, Linux, BSD. On Windows: WSL2 is preferred, but cygwin or msys also mostly work.</li> <li><code>bash</code> v4 or greater</li> <li><code>git</code></li> <li><code>curl</code>, <code>wget</code>, or <code>fetch</code> (for installation)</li> <li><code>python3</code> with <code>venv</code> module (for Ansible virtual environments)</li> </ul>"},{"location":"#installation","title":"Installation","text":"<p>Flamelet is installed by running one of the following commands in your terminal:</p> Method Command curl <code>sh -c \"$(curl -fsSL https://raw.githubusercontent.com/flameletlabs/flamelet/main/tools/install.sh)\"</code> wget <code>sh -c \"$(wget -O- https://raw.githubusercontent.com/flameletlabs/flamelet/main/tools/install.sh)\"</code> fetch <code>sh -c \"$(fetch -o - https://raw.githubusercontent.com/flameletlabs/flamelet/main/tools/install.sh)\"</code> <p>This clones the flamelet repository to <code>~/.flamelet/bin/</code> and creates a symlink at <code>~/bin/flamelet</code>.</p> <p>To install to a custom path, set the <code>FLAMELET</code> environment variable:</p> <pre><code>FLAMELET=/opt/flamelet sh install.sh\n</code></pre> <p>The installer also respects <code>REPO</code>, <code>REMOTE</code>, and <code>BRANCH</code> environment variables for custom source locations.</p>"},{"location":"#first-run","title":"First Run","text":"<p>The fastest way to get started is with the example-local tenant:</p> <pre><code># Clone the example tenant\ngit clone https://github.com/flameletlabs/example-local.git \\\n  ~/.flamelet/tenant/flamelet-example-local\n\n# Install Ansible in an isolated virtual environment\nflamelet -t example-local installansible\n\n# Run the playbook on localhost\nflamelet -t example-local -l ansible\n</code></pre> <p>The example playbook gathers system facts, installs a few common packages (<code>tree</code>, <code>curl</code>, <code>git</code>), and displays your current user. Once this works, you're ready to build your own tenant.</p>"},{"location":"#examples","title":"Examples","text":"<ul> <li>example-local \u2014 Local provisioning. The simplest starting point: localhost-only inventory, self-contained playbook, no external dependencies.</li> <li>example-remote (coming soon) \u2014 Remote provisioning via SSH with multi-host inventory and Galaxy roles.</li> </ul>"},{"location":"#concepts","title":"Concepts","text":"<p>Tenants \u2014 A tenant is a self-contained configuration directory that flamelet manages. Each tenant lives at <code>~/.flamelet/tenant/flamelet-&lt;name&gt;/</code> and has its own <code>config.sh</code>, Ansible inventory, playbook, and virtual environment. Switch between tenants with <code>flamelet -t &lt;name&gt;</code>.</p> <p>config.sh \u2014 The central configuration file for a tenant. It defines the tenant name, Ansible version, paths to inventory and playbook files, SSH controller settings, and Galaxy dependencies. See Configuration for the full variable reference.</p> <p>Virtual environments \u2014 Flamelet creates an isolated Python virtual environment per tenant with the specified Ansible version. Venvs are stored at <code>~/.flamelet/venv/</code> and named <code>&lt;package&gt;-&lt;tenant&gt;-&lt;version&gt;</code>. This prevents version conflicts between tenants and keeps your system Python clean.</p> <p>Remote execution \u2014 With the <code>-r</code> flag and an SSH controller configured, flamelet can run itself on a remote host. It SSHs to the controller and executes flamelet there, so the remote machine handles Ansible execution. See Advanced for details.</p> <p>Offline mode \u2014 The <code>-l</code> flag skips git checkout operations, so flamelet can operate without network access once the tenant repo and venv are set up. Useful for air-gapped environments.</p> <p>Versioning \u2014 Flamelet follows Semantic Versioning. Check your installed version with <code>flamelet --version</code> or <code>flamelet version</code> (which also checks for updates). See the Changelog for release history.</p> <p>Health checks \u2014 Run <code>flamelet doctor</code> to check for stale virtual environments and available flamelet updates. Add <code>-t &lt;tenant&gt;</code> to also check for Ansible version upgrades (via PyPI), unused Galaxy collections, and unused Galaxy roles. See doctor for details.</p>"},{"location":"advanced/","title":"Advanced Features","text":""},{"location":"advanced/#remote-execution","title":"Remote Execution","text":"<p>Flamelet can run on a remote host via an SSH controller. This is useful when you have a dedicated provisioning server that runs Ansible against your infrastructure, and you want to trigger it from your local machine.</p>"},{"location":"advanced/#how-it-works","title":"How it works","text":"<ol> <li>You run <code>flamelet -t &lt;tenant&gt; -r ansible</code> on your local machine</li> <li>Flamelet SSHs to the host defined in <code>CFG_SSH_CONTROLLER</code></li> <li>On the remote host, flamelet runs the same command without the <code>-r</code> flag</li> <li>The remote host executes Ansible against your infrastructure</li> </ol>"},{"location":"advanced/#setup","title":"Setup","text":"<p>1. Configure the SSH controller in <code>config.sh</code>:</p> <pre><code>CFG_SSH_CONTROLLER=\"admin@controller.example\"\nCFG_SSH_OPTIONS=(-o StrictHostKeyChecking=no -o ForwardAgent=yes)\nCFG_SCP_OPTIONS=(-o StrictHostKeyChecking=no)\n</code></pre> <p>2. Install flamelet on the remote host:</p> <pre><code>flamelet -t myproject -r installremote\n</code></pre> <p>This copies the flamelet script and libraries to <code>~/.flamelet/bin/</code> on the remote controller.</p> <p>3. Set up the tenant on the remote host:</p> <p>The remote host needs its own tenant configuration. Either:</p> <ul> <li>Set <code>CFG_FLAMELET_TENANT_REPO</code> so the remote can clone the tenant repo, or</li> <li>Manually place the tenant directory at <code>~/.flamelet/tenant/flamelet-&lt;name&gt;/</code> on the remote</li> </ul> <p>4. Install Ansible on the remote host:</p> <pre><code>flamelet -t myproject -r installansible\n</code></pre> <p>5. Run playbooks remotely:</p> <pre><code>flamelet -t myproject -r ansible\nflamelet -t myproject -r ansible -o \"--tags users --limit debian\"\n</code></pre>"},{"location":"advanced/#how-arguments-are-forwarded","title":"How arguments are forwarded","text":"<p>When using <code>-r</code>, flamelet strips the <code>-r</code> flag from the arguments and forwards everything else to the remote flamelet via SSH. For example:</p> <pre><code># Local command:\nflamelet -t myproject -r -l ansible -o \"--tags users\"\n\n# Becomes on remote:\nflamelet -t myproject -l ansible -o \"--tags users\"\n</code></pre>"},{"location":"advanced/#offline-mode","title":"Offline Mode","text":"<p>The <code>-l</code> (or <code>--offline</code>) flag tells flamelet to skip all git checkout operations. Use this when:</p> <ul> <li>The tenant repo is already cloned and you don't want to pull changes</li> <li>You're in an air-gapped environment with no network access</li> <li>You're iterating quickly on local changes and don't want git to overwrite them</li> </ul> <pre><code># Run without checking out the repo\nflamelet -t myproject -l ansible\n\n# Install ansible without checkout\nflamelet -t myproject -l installansible\n</code></pre> <p>For a fully offline setup:</p> <ol> <li>Clone the tenant repo manually while you have network access</li> <li>Run <code>flamelet -t &lt;tenant&gt; installansible</code> to create the venv</li> <li>From then on, use <code>-l</code> for all commands</li> </ol>"},{"location":"advanced/#network-scanning-with-nmap","title":"Network Scanning with nmap","text":"<p>Flamelet includes an nmap wrapper that scans configured subnets and generates HTML reports.</p>"},{"location":"advanced/#configuration","title":"Configuration","text":"<p>In <code>config.sh</code>, define subnets as an associative array:</p> <pre><code>declare -A CFG_NMAP_SUBNETS=(\n    [office]=\"192.168.1.0/24\"\n    [servers]=\"10.0.0.0/24\"\n    [dmz]=\"172.16.0.0/24\"\n)\n\n# Default options for all subnets\nCFG_NMAP_OPTS=\"-sV -O\"\n\n# Per-subnet overrides (optional)\ndeclare -A CFG_NMAP_SUBNETS_OPTS=(\n    [dmz]=\"-sV -O -Pn\"\n)\n</code></pre>"},{"location":"advanced/#running-scans","title":"Running scans","text":"<pre><code>flamelet -t myproject nmap\n</code></pre> <p>This will:</p> <ol> <li>Download the nmap-bootstrap-xsl stylesheet (cached at <code>/tmp/nmap-bootstrap.xsl</code>)</li> <li>Run <code>sudo nmap</code> for each configured subnet</li> <li>Generate per-subnet XML and HTML reports in <code>/tmp/nmap_reports/</code></li> <li>Create an <code>index.html</code> linking all reports</li> <li>Start a Python HTTP server on port 8100 to serve the reports</li> </ol> <p>Reports are accessible at <code>http://&lt;host&gt;:8100/index.html</code>.</p>"},{"location":"advanced/#makefile-shortcuts","title":"Makefile Shortcuts","text":"<p>For tenants you use frequently, a <code>Makefile</code> can simplify common operations:</p> <pre><code>TENANT = myproject\n\n.PHONY: run install checkout remote nmap\n\nrun:\n    flamelet -t $(TENANT) -l ansible\n\ninstall:\n    flamelet -t $(TENANT) installansible\n\ncheckout:\n    flamelet -t $(TENANT) checkout\n\nremote:\n    flamelet -t $(TENANT) -r ansible\n\nnmap:\n    flamelet -t $(TENANT) nmap\n\ntags-%:\n    flamelet -t $(TENANT) -l ansible -o \"--tags $*\"\n\nlimit-%:\n    flamelet -t $(TENANT) -l ansible -o \"--limit $*\"\n</code></pre> <p>Usage:</p> <pre><code>make run                # Run the playbook\nmake remote             # Run remotely\nmake tags-users         # Run only the users tag\nmake limit-debian       # Limit to debian group\n</code></pre>"},{"location":"advanced/#versioning-and-updates","title":"Versioning and Updates","text":""},{"location":"advanced/#checking-your-version","title":"Checking your version","text":"<pre><code># Print version and exit\nflamelet --version\n\n# Print version and check for available updates\nflamelet version\n</code></pre> <p>The <code>version</code> command fetches the latest version from GitHub and tells you whether an update is available.</p>"},{"location":"advanced/#updating","title":"Updating","text":"<pre><code>flamelet update\n</code></pre> <p>This shows the current version, fetches the latest from the flamelet GitHub repository, and resets the local installation. After updating, it reports the version change (e.g., <code>flamelet updated: 1.0.0 -&gt; 1.1.0</code>) or confirms you are already up to date. No tenant is required.</p> <p>If you installed flamelet to a custom path, <code>cd</code> into that directory first and run <code>git pull</code> manually.</p>"},{"location":"advanced/#health-checks","title":"Health checks","text":"<p>Run <code>flamelet -t &lt;tenant&gt; doctor</code> to check for unused Galaxy dependencies, available Ansible upgrades, and stale virtual environments. Without <code>-t</code>, only global checks (flamelet version, stale venvs) are run. See doctor in the CLI reference for details.</p>"},{"location":"advanced/#release-process","title":"Release process","text":"<p>Flamelet follows Semantic Versioning. The current version is tracked in the <code>VERSION</code> file at the repository root. Releases are tagged with <code>v&lt;version&gt;</code> (e.g., <code>v1.0.0</code>) and GitHub Releases are created automatically via GitHub Actions.</p>"},{"location":"advanced/#uninstalling-flamelet","title":"Uninstalling Flamelet","text":"<p>To completely remove flamelet and all its data:</p> <pre><code>rm -rf ~/.flamelet ~/bin/flamelet\n</code></pre> <p>This removes:</p> <ul> <li>The flamelet installation (<code>~/.flamelet/bin/</code>)</li> <li>All virtual environments (<code>~/.flamelet/venv/</code>)</li> <li>All tenant directories (<code>~/.flamelet/tenant/</code>)</li> <li>The symlink (<code>~/bin/flamelet</code>)</li> </ul> <p>To remove only a specific tenant's venv while keeping everything else:</p> <pre><code>rm -rf ~/.flamelet/venv/ansible-myproject-9.12.0\n</code></pre>"},{"location":"advanced/#galaxy-roles-and-collections","title":"Galaxy Roles and Collections","text":"<p>Flamelet manages Galaxy dependencies through <code>config.sh</code> variables. They are installed (or removed and reinstalled) every time you run <code>installansible</code>.</p>"},{"location":"advanced/#collections","title":"Collections","text":"<pre><code># In config.sh\nCFG_ANSIBLE_GALAXY_COLLECTIONS_INSTALL=\"community.general ansible.posix community.docker\"\nCFG_ANSIBLE_GALAXY_COLLECTIONS_REMOVE=\"community.general ansible.posix community.docker\"\n</code></pre>"},{"location":"advanced/#roles","title":"Roles","text":"<pre><code># In config.sh\nCFG_ANSIBLE_GALAXY_ROLES_INSTALL=\"geerlingguy.docker geerlingguy.certbot\"\nCFG_ANSIBLE_GALAXY_ROLES_REMOVE=\"geerlingguy.docker geerlingguy.certbot\"\n</code></pre> <p>The <code>_REMOVE</code> variables are processed first, ensuring a clean install. This is useful when upgrading to newer versions of roles or collections.</p>"},{"location":"advanced/#finding-roles-and-collections","title":"Finding roles and collections","text":"<p>Browse Ansible Galaxy to discover roles and collections. Filter by \"Roles\" or \"Collections\" and check download counts and maintenance status before adding dependencies.</p>"},{"location":"changelog/","title":"Changelog","text":"<p>All notable changes to this project will be documented in this file.</p> <p>The format is based on Keep a Changelog, and this project adheres to Semantic Versioning.</p>"},{"location":"changelog/#110-2026-02-17","title":"1.1.0 - 2026-02-17","text":""},{"location":"changelog/#added","title":"Added","text":"<ul> <li><code>doctor</code> command \u2014 run <code>flamelet doctor</code> for global health checks or <code>flamelet -t &lt;tenant&gt; doctor</code> for full tenant diagnostics</li> <li>Stale venv cleanup \u2014 detects virtual environments under <code>~/.flamelet/venv/</code> that no longer match any tenant's <code>config.sh</code> (e.g. leftover after version bumps), with interactive or <code>--force</code> deletion; respects <code>--dryrun</code></li> <li>Ansible version check \u2014 queries PyPI for the latest stable release and the latest patch in the current major.minor series</li> <li>Unused Galaxy collections \u2014 scans tenant YAML files for FQCN references and reports collections with no matches</li> <li>Unused Galaxy roles \u2014 scans tenant YAML files for role references (strips version pins) and reports roles with no matches</li> <li>MkDocs search \u2014 enabled the built-in search plugin for the documentation site</li> </ul>"},{"location":"changelog/#fixed","title":"Fixed","text":"<ul> <li>Option parsing \u2014 flags like <code>-o</code> now work in any position, including after the command name (e.g. <code>flamelet -t x ansiblemodule -o \"all -m ping\"</code> previously corrupted the options to <code>nse</code>)</li> <li>Empty option guard \u2014 <code>_ansible_()</code> and <code>_ansibleModule_()</code> no longer mangle an unset <code>-o</code> value</li> </ul>"},{"location":"changelog/#100-2026-02-17","title":"1.0.0 - 2026-02-17","text":"<p>First stable release.</p>"},{"location":"changelog/#added_1","title":"Added","text":"<ul> <li>Semantic versioning \u2014 <code>VERSION</code> file as single source of truth, <code>--version</code> / <code>-V</code> flag, <code>version</code> command with remote update checking</li> <li>Version-aware updates \u2014 <code>flamelet update</code> now shows before/after versions</li> <li>GitHub Actions release workflow \u2014 automatically creates a GitHub Release on tag push</li> <li>Installer version display \u2014 <code>tools/install.sh</code> prints the installed version</li> <li>Remote install includes VERSION \u2014 <code>installremote</code> copies the VERSION file to the remote host</li> <li>Ad-hoc Ansible modules \u2014 <code>ansiblemodule</code> command for running ad-hoc Ansible modules (<code>ping</code>, <code>command</code>, <code>raw</code>, <code>shell</code>, etc.) without a playbook</li> <li>Collection removal fix \u2014 use <code>rm -rf</code> instead of <code>ansible-galaxy collection remove</code>, which does not exist</li> <li>Multi-page documentation site \u2014 full MkDocs Material site with CLI reference, configuration guide, usage patterns, and advanced features</li> <li>Example tenant documentation \u2014 <code>example-local</code> tenant with step-by-step instructions</li> <li><code>conf_*_custom</code> composition pattern \u2014 documented approach for composable default/custom variable overrides</li> </ul>"},{"location":"changelog/#features-carried-from-pre-release-development","title":"Features carried from pre-release development","text":"<ul> <li>Multi-tenant support with isolated configuration per tenant</li> <li>Per-tenant Python virtual environments with pinned Ansible versions</li> <li>Remote execution via SSH controller (<code>-r</code> flag)</li> <li>Offline mode for air-gapped environments (<code>-l</code> flag)</li> <li>Dry run mode (<code>-n</code> flag)</li> <li>Tenant repository checkout and branch tracking</li> <li>System dependency installation across Debian, RedHat, FreeBSD, and OpenBSD</li> <li>Network scanning with nmap and HTML report generation</li> <li>System info and dependency checking (<code>sysinfo</code>)</li> <li>Galaxy roles and collections management</li> <li>Configurable SSH, SCP, and git options</li> <li>Environment file loading (<code>env.sh</code> at global and tenant level)</li> <li>Flexible logging with configurable log levels and log files</li> </ul>"},{"location":"commands/","title":"CLI Reference","text":""},{"location":"commands/#synopsis","title":"Synopsis","text":"<pre><code>flamelet [OPTIONS] [COMMAND]\n</code></pre> <p>Flamelet requires a tenant (<code>-t</code>) for most commands. The exceptions are <code>sysinfo</code>, <code>update</code>, <code>version</code>, and <code>doctor</code> (without <code>-t</code>), which operate on the flamelet installation itself.</p>"},{"location":"commands/#commands","title":"Commands","text":""},{"location":"commands/#ansible","title":"ansible","text":"<p>Run an Ansible playbook for a tenant.</p> <pre><code>flamelet -t &lt;tenant&gt; ansible\n</code></pre> <p>Activates the tenant's virtual environment, optionally checks out the tenant repo (unless <code>-l</code> is set), and runs <code>ansible-playbook</code> with the inventory, playbook, and options defined in <code>config.sh</code>.</p> <p>Pass additional Ansible arguments via <code>-o</code>:</p> <pre><code>flamelet -t &lt;tenant&gt; ansible -o \"--tags users --limit debian\"\n</code></pre>"},{"location":"commands/#ansiblemodule","title":"ansiblemodule","text":"<p>Run ad-hoc Ansible modules against your inventory without writing a playbook.</p> <pre><code>flamelet -t &lt;tenant&gt; ansiblemodule -o \"&lt;ansible-arguments&gt;\"\n</code></pre> <p>Activates the tenant's virtual environment and runs <code>ansible</code> (not <code>ansible-playbook</code>) with the inventory and options from <code>config.sh</code>. Output is one-line-per-host format. Use <code>-o</code> to pass the target hosts, module, and arguments.</p>"},{"location":"commands/#ping-hosts","title":"Ping hosts","text":"<p>Check which hosts are reachable and have a working Python environment:</p> <pre><code># Ping all hosts in inventory\nflamelet -t mytenant ansiblemodule -o \"all -m ping\"\n\n# Ping a specific group\nflamelet -t mytenant ansiblemodule -o \"debian -m ping\"\n\n# Ping a single host\nflamelet -t mytenant ansiblemodule -o \"web-01.example -m ping\"\n</code></pre>"},{"location":"commands/#run-commands","title":"Run commands","text":"<p>Execute commands on remote hosts using the <code>command</code> module (default module) or <code>shell</code> (when you need pipes, redirects, or shell features):</p> <pre><code># Check uptime on all hosts\nflamelet -t mytenant ansiblemodule -o \"all -m command -a 'uptime'\"\n\n# Disk usage on webservers\nflamelet -t mytenant ansiblemodule -o \"webservers -m command -a 'df -h'\"\n\n# Use shell module for pipes and redirects\nflamelet -t mytenant ansiblemodule -o \"all -m shell -a 'ps aux | grep nginx'\"\n\n# Check a service status\nflamelet -t mytenant ansiblemodule -o \"debian -m shell -a 'systemctl status nginx'\"\n</code></pre>"},{"location":"commands/#raw-commands","title":"Raw commands","text":"<p>The <code>raw</code> module executes commands directly over SSH without requiring Python on the remote host. Useful for bootstrapping fresh machines or managing minimal systems:</p> <pre><code># Run on hosts that may not have Python installed\nflamelet -t mytenant ansiblemodule -o \"all -m raw -a 'uname -a'\"\n\n# Bootstrap Python on a fresh Debian host\nflamelet -t mytenant ansiblemodule -o \"newhost.example -m raw -a 'apt-get -y install python3'\"\n\n# Works on any host with SSH access, regardless of OS\nflamelet -t mytenant ansiblemodule -o \"freebsd -m raw -a 'pkg info'\"\n</code></pre>"},{"location":"commands/#other-useful-modules","title":"Other useful modules","text":"<p>Any Ansible module can be used with <code>ansiblemodule</code>:</p> <pre><code># Gather facts\nflamelet -t mytenant ansiblemodule -o \"all -m setup -a 'filter=ansible_os_family'\"\n\n# Copy a file\nflamelet -t mytenant ansiblemodule -o \"webservers -m copy -a 'src=/tmp/config.conf dest=/etc/app/config.conf'\"\n\n# Install a package\nflamelet -t mytenant ansiblemodule -o \"debian -m apt -a 'name=htop state=present' --become\"\n\n# Manage services\nflamelet -t mytenant ansiblemodule -o \"webservers -m service -a 'name=nginx state=restarted' --become\"\n</code></pre>"},{"location":"commands/#installansible","title":"installansible","text":"<p>Create or update the Ansible virtual environment for a tenant.</p> <pre><code>flamelet -t &lt;tenant&gt; installansible\n</code></pre> <p>This command:</p> <ol> <li>Checks out the tenant repo (if <code>CFG_FLAMELET_TENANT_REPO</code> is set and not in offline mode)</li> <li>Creates a Python virtual environment at <code>~/.flamelet/venv/&lt;package&gt;-&lt;tenant&gt;-&lt;version&gt;/</code></li> <li>Installs pip, the configured Ansible package and version, plus <code>jmespath</code> and <code>six</code></li> <li>Removes and installs Galaxy collections (if <code>CFG_ANSIBLE_GALAXY_COLLECTIONS_REMOVE</code> / <code>_INSTALL</code> are set)</li> <li>Removes and installs Galaxy roles (if <code>CFG_ANSIBLE_GALAXY_ROLES_REMOVE</code> / <code>_INSTALL</code> are set)</li> </ol> <p>Run this once when setting up a new tenant, or again when changing the Ansible version or Galaxy dependencies.</p>"},{"location":"commands/#doctor","title":"doctor","text":"<p>Run health checks on flamelet and tenant configuration.</p> <pre><code>flamelet doctor\nflamelet -t &lt;tenant&gt; doctor\n</code></pre> <p>Without a tenant, <code>doctor</code> runs global checks only:</p> <ul> <li>Flamelet version \u2014 checks if a newer version is available on GitHub</li> <li>Stale virtual environments \u2014 finds venvs under <code>~/.flamelet/venv/</code> that don't match any tenant's current <code>config.sh</code> (e.g. left over after a version bump), and offers to delete them</li> </ul> <p>With a tenant (<code>-t</code>), it also runs:</p> <ul> <li>Ansible version check \u2014 queries PyPI for the latest stable release and the latest patch in your current major.minor series</li> <li>Unused Galaxy collections \u2014 scans tenant YAML files for FQCN references to each installed collection; reports collections with no matches</li> <li>Unused Galaxy roles \u2014 scans tenant YAML files for role references; reports roles with no matches</li> </ul> <p>Useful flags:</p> Flag Effect <code>-n</code> / <code>--dryrun</code> Show what would be deleted without actually removing stale venvs <code>--force</code> Skip confirmation prompts (auto-yes for venv cleanup) <code>-v</code> / <code>--verbose</code> Show debug detail during checks"},{"location":"commands/#checkout","title":"checkout","text":"<p>Clone or update the tenant repository.</p> <pre><code>flamelet -t &lt;tenant&gt; checkout\n</code></pre> <p>If the tenant directory has no <code>.git</code> directory, clones the repo from <code>CFG_FLAMELET_TENANT_REPO</code>. Otherwise, fetches and resets to the configured branch (<code>CFG_FLAMELET_TENANT_BRANCH</code>, defaults to <code>origin/HEAD</code>).</p> <p>This happens automatically before <code>ansible</code>, <code>ansiblemodule</code>, and <code>installansible</code> when a repo is configured and offline mode is not set.</p>"},{"location":"commands/#installremote","title":"installremote","text":"<p>Install flamelet on a remote host via SSH.</p> <pre><code>flamelet -t &lt;tenant&gt; -r installremote\n</code></pre> <p>Copies the flamelet script and all library files to <code>~/.flamelet/bin/</code> on the remote SSH controller. Requires <code>CFG_SSH_CONTROLLER</code> to be set in <code>config.sh</code>.</p> <p>After running this, you can use <code>flamelet -t &lt;tenant&gt; -r ansible</code> to execute playbooks on the remote host.</p>"},{"location":"commands/#nmap","title":"nmap","text":"<p>Run network scans on configured subnets.</p> <pre><code>flamelet -t &lt;tenant&gt; nmap\n</code></pre> <p>Requires <code>CFG_NMAP_SUBNETS</code> (associative array of subnet names to IP ranges) in <code>config.sh</code>. Generates HTML reports using the nmap-bootstrap-xsl stylesheet and serves them via a local HTTP server on port 8100.</p> <p>Per-subnet scan options can be set via <code>CFG_NMAP_SUBNETS_OPTS</code>, falling back to <code>CFG_NMAP_OPTS</code>.</p>"},{"location":"commands/#installdeps","title":"installdeps","text":"<p>Install system dependencies for flamelet.</p> <pre><code>flamelet installdeps\n</code></pre> <p>Detects the operating system and installs required packages using the appropriate package manager:</p> OS Package Manager Packages installed Debian/Ubuntu apt-get bash, tree, rsync, git, tmux, ccze, ncdu, virt-what, python3, python3-venv, sshpass, nmap, xsltproc RedHat/CentOS yum bash, hostname, tree, rsync, git, tmux, ccze, ncdu, python3 FreeBSD pkg bash, tree, rsync, git-lite, tmux, ccze, ncdu, wget, rust, nmap, libxslt OpenBSD pkg_add bash, tree, rsync, git, ncdu, python3, wget, rust, nmap, libxslt <p>This command does not require a tenant.</p>"},{"location":"commands/#sysinfo","title":"sysinfo","text":"<p>Show system information and check dependency status.</p> <pre><code>flamelet sysinfo\n</code></pre> <p>Reports the detected OS, Linux distribution (if applicable), and checks for the presence of: bash, python3, rsync, git, tmux, tree, ccze, ncdu. Also checks sudo availability.</p> <p>This command does not require a tenant.</p>"},{"location":"commands/#update","title":"update","text":"<p>Update flamelet itself.</p> <pre><code>flamelet update\n</code></pre> <p>Shows the current version, fetches the latest from the flamelet GitHub repository, and resets the local installation to match. After updating, it reports whether the version changed (e.g., <code>flamelet updated: 1.0.0 -&gt; 1.1.0</code>) or if you were already up to date. If <code>~/.flamelet/bin/</code> is not yet a git repo, it re-clones from scratch.</p> <p>This command does not require a tenant.</p>"},{"location":"commands/#version","title":"version","text":"<p>Show the current flamelet version and check for updates.</p> <pre><code>flamelet version\n</code></pre> <p>Prints the local version, then fetches the latest version from GitHub and compares. If a newer version is available, it tells you to run <code>flamelet update</code>.</p> <p>This command does not require a tenant.</p>"},{"location":"commands/#options","title":"Options","text":""},{"location":"commands/#tenant","title":"Tenant","text":"Flag Long Description <code>-t</code> <code>--tenant</code> Required for most commands. Specifies which tenant configuration to use. Corresponds to the directory <code>~/.flamelet/tenant/flamelet-&lt;name&gt;/</code>."},{"location":"commands/#execution-mode","title":"Execution mode","text":"Flag Long Description <code>-r</code> <code>--remote</code> Run the command on the remote SSH controller instead of locally. The <code>-r</code> flag is stripped from the arguments before forwarding. <code>-l</code> <code>--offline</code> Offline mode. Skips tenant repo checkout (git clone/pull). Use when the repo is already present or network is unavailable. <code>-n</code> <code>--dryrun</code> Dry run mode. Non-destructive \u2014 makes no permanent changes."},{"location":"commands/#ansible-passthrough","title":"Ansible passthrough","text":"Flag Long Description <code>-o</code> <code>--option</code> Pass additional options to the Ansible command. Quote the entire option string: <code>-o \"--tags users --limit myhost\"</code>."},{"location":"commands/#output-control","title":"Output control","text":"Flag Long Description <code>-v</code> <code>--verbose</code> Verbose output. Shows additional information during execution. <code>-q</code> <code>--quiet</code> Quiet mode. Suppresses output. <code>--force</code> Skip all user interaction. Implies \"Yes\" to all prompts. <code>--loglevel</code> Set log level. One of: <code>FATAL</code>, <code>ERROR</code>, <code>WARN</code>, <code>INFO</code>, <code>NOTICE</code>, <code>DEBUG</code>, <code>ALL</code>, <code>OFF</code>. Default: <code>ERROR</code>. <code>--logfile</code> Path to log file. Default: <code>~/logs/flamelet.log</code>."},{"location":"commands/#help-and-version","title":"Help and version","text":"Flag Long Description <code>-h</code> <code>--help</code> Display usage information and exit. <code>-V</code> <code>--version</code> Display the current version and exit."},{"location":"commands/#usage-examples","title":"Usage Examples","text":"<pre><code># Run a playbook locally (offline mode, no repo checkout)\nflamelet -t myproject -l ansible\n\n# Run a playbook with specific tags\nflamelet -t myproject -l ansible -o \"--tags packages,users\"\n\n# Limit to specific hosts\nflamelet -t myproject -l ansible -o \"--limit webservers\"\n\n# Run a playbook remotely via SSH controller\nflamelet -t myproject -r ansible\n\n# Run ad-hoc ping on all hosts\nflamelet -t myproject ansiblemodule -o \"all -m ping\"\n\n# Set up a new tenant from scratch\nflamelet -t myproject installansible\n\n# Install flamelet on the remote controller\nflamelet -t myproject -r installremote\n\n# Check system dependencies\nflamelet sysinfo\n\n# Check version and available updates\nflamelet version\n\n# Print version only\nflamelet --version\n\n# Update flamelet\nflamelet update\n\n# Run global health checks (version + stale venvs)\nflamelet doctor\n\n# Run full health checks for a tenant\nflamelet -t myproject doctor\n\n# Dry-run: see what stale venvs would be deleted\nflamelet -n -t myproject doctor\n\n# Auto-confirm venv cleanup\nflamelet --force -t myproject doctor\n</code></pre>"},{"location":"configuration/","title":"Configuration","text":""},{"location":"configuration/#directory-layout","title":"Directory Layout","text":"<p>Flamelet uses a single base directory at <code>~/.flamelet/</code> with the following structure:</p> <pre><code>~/.flamelet/\n\u251c\u2500\u2500 bin/                              # Flamelet installation (git repo)\n\u2502   \u251c\u2500\u2500 flamelet                      # Main script\n\u2502   \u2514\u2500\u2500 share/flamelet/               # Library files (.bash)\n\u251c\u2500\u2500 venv/                             # Python virtual environments\n\u2502   \u2514\u2500\u2500 ansible-myproject-9.12.0/     # One venv per tenant+version\n\u251c\u2500\u2500 tenant/                           # Tenant directories\n\u2502   \u2514\u2500\u2500 flamelet-myproject/           # Tenant: \"myproject\"\n\u2502       \u251c\u2500\u2500 config.sh                 # Tenant configuration\n\u2502       \u251c\u2500\u2500 env.sh                    # Per-tenant environment (optional)\n\u2502       \u251c\u2500\u2500 ansible.cfg               # Ansible configuration\n\u2502       \u251c\u2500\u2500 inventory/                # Ansible inventory files\n\u2502       \u2514\u2500\u2500 playbook.yml              # Ansible playbook\n\u2514\u2500\u2500 env.sh                            # Global environment (optional)\n</code></pre> <p>A symlink at <code>~/bin/flamelet</code> points to <code>~/.flamelet/bin/flamelet</code>.</p>"},{"location":"configuration/#configsh","title":"config.sh","text":"<p>Each tenant has a <code>config.sh</code> file at <code>~/.flamelet/tenant/flamelet-&lt;name&gt;/config.sh</code>. Flamelet sources this file before executing any tenant command. All variables are bash variables.</p>"},{"location":"configuration/#tenant-identity","title":"Tenant identity","text":"Variable Description <code>CFG_TENANT</code> Tenant name. Should match the directory suffix (e.g., <code>myproject</code> for <code>flamelet-myproject/</code>)."},{"location":"configuration/#ansible-settings","title":"Ansible settings","text":"Variable Default Description <code>CFG_ANSIBLE_PACKAGE</code> <code>ansible</code> Python package to install. Usually <code>ansible</code> or <code>ansible-core</code>. <code>CFG_ANSIBLE_VERSION</code> (required) Version to install (e.g., <code>9.12.0</code>). Used by <code>installansible</code> to pin the Ansible version. <code>CFG_ANSIBLE_CONFIG</code> <code>/etc/ansible/ansible.cfg</code> Path to <code>ansible.cfg</code>. Usually set to the tenant's own config file. <code>CFG_ANSIBLE_INVENTORY</code> (required) Path to the inventory file or directory, relative to the tenant directory. <code>CFG_ANSIBLE_PLAYBOOK</code> (required) Path to the playbook file, relative to the tenant directory. <code>CFG_ANSIBLE_OPTIONS</code> (empty array) Additional options passed to every <code>ansible-playbook</code> invocation."},{"location":"configuration/#repository-settings","title":"Repository settings","text":"Variable Default Description <code>CFG_FLAMELET_TENANT_REPO</code> (empty) Git URL of the tenant repository. If set, flamelet will clone/update the repo before running commands. Leave empty for locally-managed tenants. <code>CFG_FLAMELET_TENANT_BRANCH</code> <code>origin/HEAD</code> Git branch to check out."},{"location":"configuration/#ssh-and-remote-execution","title":"SSH and remote execution","text":"Variable Description <code>CFG_SSH_CONTROLLER</code> SSH destination for remote execution (e.g., <code>admin@controller.example</code>). Used with <code>-r</code> flag. <code>CFG_SSH_OPTIONS</code> Array of SSH options passed to <code>ssh</code> commands (e.g., <code>-o StrictHostKeyChecking=no</code>). <code>CFG_SCP_OPTIONS</code> Array of SCP options. Falls back to <code>CFG_SSH_OPTIONS</code> if not set. <code>CFG_GIT_OPTIONS</code> Options passed to <code>git</code> commands during checkout."},{"location":"configuration/#galaxy-dependencies","title":"Galaxy dependencies","text":"Variable Description <code>CFG_ANSIBLE_GALAXY_COLLECTIONS_INSTALL</code> Collections to install via <code>ansible-galaxy collection install</code>. <code>CFG_ANSIBLE_GALAXY_COLLECTIONS_REMOVE</code> Collections to remove before install (ensures clean state). <code>CFG_ANSIBLE_GALAXY_ROLES_INSTALL</code> Roles to install via <code>ansible-galaxy role install</code>. <code>CFG_ANSIBLE_GALAXY_ROLES_REMOVE</code> Roles to remove before install. <p>Use <code>flamelet -t &lt;tenant&gt; doctor</code> to check for collections and roles that are configured but not referenced in your tenant's YAML files.</p>"},{"location":"configuration/#network-scanning","title":"Network scanning","text":"Variable Description <code>CFG_NMAP_SUBNETS</code> Associative array mapping subnet names to IP ranges (e.g., <code>[lan]=\"192.168.1.0/24\"</code>). <code>CFG_NMAP_SUBNETS_OPTS</code> Associative array mapping subnet names to nmap options. Falls back to <code>CFG_NMAP_OPTS</code>. <code>CFG_NMAP_OPTS</code> Default nmap options applied to all subnets (if per-subnet opts are not set)."},{"location":"configuration/#environment-files","title":"Environment Files","text":"<p>Flamelet supports optional environment files for setting shell variables, aliases, or other shell customizations that shouldn't live in <code>config.sh</code>.</p> File Scope Description <code>~/.flamelet/env.sh</code> Global Sourced for every tenant. Use for shared settings like SSH agent forwarding or PATH additions. <code>~/.flamelet/tenant/flamelet-&lt;name&gt;/env.sh</code> Per-tenant Sourced after the global env. Use for tenant-specific environment variables."},{"location":"configuration/#loading-order","title":"Loading Order","text":"<p>When flamelet runs a tenant command, configuration is loaded in this order:</p> <ol> <li>config.sh \u2014 <code>~/.flamelet/tenant/flamelet-&lt;name&gt;/config.sh</code></li> <li>Global env.sh \u2014 <code>~/.flamelet/env.sh</code> (if it exists)</li> <li>Tenant env.sh \u2014 <code>~/.flamelet/tenant/flamelet-&lt;name&gt;/env.sh</code> (if it exists)</li> </ol> <p>Later files can override variables set by earlier files. This lets you set defaults in <code>config.sh</code>, apply global overrides in the global env, and apply tenant-specific overrides last.</p>"},{"location":"configuration/#virtual-environment-naming","title":"Virtual Environment Naming","text":"<p>Each tenant gets an isolated Python virtual environment. The naming convention is:</p> <pre><code>~/.flamelet/venv/&lt;CFG_ANSIBLE_PACKAGE&gt;-&lt;CFG_TENANT&gt;-&lt;CFG_ANSIBLE_VERSION&gt;/\n</code></pre> <p>For example, a tenant named <code>myproject</code> using <code>ansible</code> version <code>9.12.0</code>:</p> <pre><code>~/.flamelet/venv/ansible-myproject-9.12.0/\n</code></pre> <p>This means you can have multiple tenants with different Ansible versions without conflicts.</p> <p>When you change the Ansible version in <code>config.sh</code>, the old venv remains on disk. Run <code>flamelet doctor</code> to detect and clean up stale venvs.</p>"},{"location":"configuration/#example-minimal-configsh-local","title":"Example: Minimal config.sh (local)","text":"<p>A minimal configuration for local provisioning with no external repository:</p> <pre><code>CFG_TENANT=\"example-local\"\nCFG_ANSIBLE_PACKAGE=\"ansible\"\nCFG_ANSIBLE_VERSION=\"9.12.0\"\nCFG_ANSIBLE_CONFIG=\"${HOME}/.flamelet/tenant/flamelet-example-local/ansible.cfg\"\nCFG_ANSIBLE_INVENTORY=\"${HOME}/.flamelet/tenant/flamelet-example-local/inventory/hosts\"\nCFG_ANSIBLE_PLAYBOOK=\"${HOME}/.flamelet/tenant/flamelet-example-local/playbook.yml\"\n</code></pre>"},{"location":"configuration/#example-full-configsh-remote-with-ssh-controller","title":"Example: Full config.sh (remote with SSH controller)","text":"<p>A full configuration for remote provisioning with a git-managed tenant repo and Galaxy dependencies:</p> <pre><code>CFG_TENANT=\"myproject\"\nCFG_ANSIBLE_PACKAGE=\"ansible\"\nCFG_ANSIBLE_VERSION=\"9.12.0\"\n\n# Tenant repository\nCFG_FLAMELET_TENANT_REPO=\"git@github.com:yourorg/your-tenant.git\"\nCFG_FLAMELET_TENANT_BRANCH=\"main\"\n\n# Ansible paths\nCFG_ANSIBLE_CONFIG=\"${HOME}/.flamelet/tenant/flamelet-myproject/ansible.cfg\"\nCFG_ANSIBLE_INVENTORY=\"${HOME}/.flamelet/tenant/flamelet-myproject/inventory/\"\nCFG_ANSIBLE_PLAYBOOK=\"${HOME}/.flamelet/tenant/flamelet-myproject/playbook.yml\"\n\n# SSH controller for remote execution\nCFG_SSH_CONTROLLER=\"admin@controller.example\"\nCFG_SSH_OPTIONS=(-o StrictHostKeyChecking=no -o ForwardAgent=yes)\nCFG_SCP_OPTIONS=(-o StrictHostKeyChecking=no)\n\n# Galaxy dependencies\nCFG_ANSIBLE_GALAXY_COLLECTIONS_INSTALL=\"community.general ansible.posix\"\nCFG_ANSIBLE_GALAXY_ROLES_INSTALL=\"geerlingguy.docker\"\n\n# Network scanning\ndeclare -A CFG_NMAP_SUBNETS=(\n    [office]=\"192.168.1.0/24\"\n    [servers]=\"10.0.0.0/24\"\n)\nCFG_NMAP_OPTS=\"-sV -O\"\n</code></pre>"},{"location":"usage/","title":"Usage Patterns","text":"<p>This page covers common patterns for organizing Ansible inventories, playbooks, and variables when using flamelet.</p>"},{"location":"usage/#inventory-organization","title":"Inventory Organization","text":"<p>Inventories live in the tenant's <code>inventory/</code> directory. You can use a single <code>hosts</code> file or split hosts across multiple files in the directory.</p>"},{"location":"usage/#group-by-os","title":"Group by OS","text":"<p>Organize hosts by operating system so you can target OS-specific tasks:</p> <pre><code>[debian]\nweb-01.example\nweb-02.example\ndb-01.example\n\n[freebsd]\nfirewall-01.example\njail-host-01.example\n\n[openbsd]\ngateway-01.example\n</code></pre>"},{"location":"usage/#group-by-function","title":"Group by function","text":"<p>Overlay functional groups on top of OS groups:</p> <pre><code>[docker]\nweb-01.example\nweb-02.example\n\n[k3s]\nk8s-01.example\nk8s-02.example\nk8s-03.example\n\n[monitoring]\nmonitor-01.example\n\n[backup]\nbackup-01.example\n</code></pre>"},{"location":"usage/#nested-children-groups","title":"Nested children groups","text":"<p>Use <code>[group:children]</code> to compose larger groups:</p> <pre><code>[linux:children]\ndebian\nredhat\n\n[all_servers:children]\nlinux\nfreebsd\nopenbsd\n</code></pre>"},{"location":"usage/#per-host-ssh-overrides","title":"Per-host SSH overrides","text":"<p>Set connection parameters per host when defaults don't apply:</p> <pre><code>[servers]\nserver-01.example\nserver-02.example ansible_host=10.0.0.5 ansible_ssh_user=root\nserver-03.example ansible_connection=local\nlegacy-box.example ansible_ssh_user=admin ansible_port=2222\n</code></pre>"},{"location":"usage/#host-ranges","title":"Host ranges","text":"<p>Use range patterns for numbered hosts:</p> <pre><code>[webservers]\nweb-[01:04].example\n\n[databases]\ndb-[01:02].example\n</code></pre>"},{"location":"usage/#complete-example-inventory","title":"Complete example inventory","text":"<pre><code># inventory/hosts\n\n[debian]\nweb-01.example\nweb-02.example\ndb-01.example\nmonitor-01.example\n\n[freebsd]\nfirewall-01.example\njail-host-01.example\n\n[openbsd]\ngateway-01.example\n\n[docker]\nweb-01.example\nweb-02.example\n\n[k3s]\nk8s-[01:03].example\n\n[monitoring]\nmonitor-01.example\n\n[linux:children]\ndebian\n\n[all_servers:children]\nlinux\nfreebsd\nopenbsd\n</code></pre>"},{"location":"usage/#playbook-patterns","title":"Playbook Patterns","text":""},{"location":"usage/#roles-with-tags-and-os-conditionals","title":"Roles with tags and OS conditionals","text":"<p>Structure your playbook with roles that are tagged and conditionally applied by OS:</p> <pre><code>---\n- hosts: all\n  become: true\n  gather_facts: true\n\n  roles:\n    - role: packages\n      tags: packages\n\n    - role: users\n      tags: users\n\n    - role: ssh\n      tags: ssh\n\n    - role: docker\n      tags: docker\n      when: \"'docker' in group_names\"\n\n    - role: monitoring\n      tags: monitoring\n      when: \"'monitoring' in group_names\"\n</code></pre>"},{"location":"usage/#the-conf_-variable-pattern","title":"The conf_* variable pattern","text":"<p>A powerful pattern in flamelet tenants is to define configuration changes as data in variables, then apply them with generic tasks in the playbook. This keeps playbooks reusable and moves all host/group specifics into <code>group_vars</code> and <code>host_vars</code>.</p> <p>The available <code>conf_*</code> types and their corresponding Ansible modules:</p> Variable Ansible module Use case <code>conf_lineinfile</code> <code>lineinfile</code> Single-line edits in config files <code>conf_blockinfile</code> <code>blockinfile</code> Multi-line block insertions <code>conf_copy</code> <code>copy</code> Deploy file content to hosts <code>conf_file</code> <code>file</code> File/directory permissions, ownership, symlinks <code>conf_get_url</code> <code>get_url</code> Download files from URLs <code>conf_sysrc</code> <code>sysrc</code> FreeBSD rc.conf settings <code>conf_cron</code> <code>cron</code> Cron job management <code>conf_shell</code> <code>shell</code> Shell commands to execute"},{"location":"usage/#the-_default-_custom-composition-pattern","title":"The _default + _custom composition pattern","text":"<p>Each <code>conf_*</code> variable is composed from two lists that are merged at runtime:</p> <ul> <li><code>conf_*_default</code> \u2014 Shared baseline defined in <code>group_vars/all</code>. Applied to every host.</li> <li><code>conf_*_custom</code> \u2014 Additions defined in <code>group_vars/&lt;os&gt;</code>, <code>group_vars/&lt;function&gt;</code>, or <code>host_vars/&lt;host&gt;</code>. Applied only where defined.</li> </ul> <p>The final <code>conf_*</code> variable is the concatenation of both:</p> <pre><code>conf_copy: \"{{ conf_copy_default|default([]) + conf_copy_custom|default([]) }}\"\n</code></pre> <p>This means you never lose the shared defaults when adding host-specific configurations \u2014 they are additive.</p> <p>Flow:</p> <pre><code>conf_*_default (group_vars/all)     +     conf_*_custom (group_vars/&lt;os&gt;, host_vars/&lt;host&gt;)\n            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 merged into \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                                  conf_*\n                            (used in playbook loops)\n</code></pre>"},{"location":"usage/#step-1-define-defaults-in-group_varsall","title":"Step 1: Define defaults in group_vars/all","text":"<p>These apply to every host in the inventory:</p> <pre><code># group_vars/all\n\nconf_lineinfile_default:\n  - service: sshd\n    regexp: \"^PermitRootLogin\"\n    line: \"PermitRootLogin prohibit-password\"\n    path: /etc/ssh/sshd_config\n  - service: sshd\n    regexp: \"^PasswordAuthentication\"\n    line: \"PasswordAuthentication no\"\n    path: /etc/ssh/sshd_config\n\nconf_copy_default:\n  - service: ''\n    content: |\n      # Managed by flamelet\n      nameserver 1.1.1.1\n      nameserver 9.9.9.9\n    dest: /etc/resolv.conf\n    group: \"{{ os_default_group[ansible_os_family] }}\"\n    mode: '0644'\n\nconf_get_url_default:\n  - url: 'https://example.com/scripts/health-check.sh'\n    dest: '/usr/local/bin/health-check.sh'\n    owner: 'root'\n    group: \"{{ os_default_group[ansible_os_family] }}\"\n    mode: '0755'\n</code></pre>"},{"location":"usage/#step-2-initialize-custom-as-empty-in-group_vars","title":"Step 2: Initialize custom as empty in group_vars","text":"<p>Set <code>_custom</code> to an empty list in OS-level group_vars so the merge always works, even for hosts that don't define their own custom list:</p> <pre><code># group_vars/freebsd\n\nconf_lineinfile_custom: []\nconf_blockinfile_custom: []\nconf_copy_custom: []\nconf_file_custom: []\nconf_get_url_custom: []\nconf_shell_custom: []\nconf_sysrc_custom: []\n\n# Compose the final variables\nconf_lineinfile: \"{{ conf_lineinfile_default|default([]) + conf_lineinfile_custom|default([]) }}\"\nconf_blockinfile: \"{{ conf_blockinfile_default|default([]) + conf_blockinfile_custom|default([]) }}\"\nconf_copy: \"{{ conf_copy_default|default([]) + conf_copy_custom|default([]) }}\"\nconf_file: \"{{ conf_file_default|default([]) + conf_file_custom|default([]) }}\"\nconf_get_url: \"{{ conf_get_url_default|default([]) + conf_get_url_custom|default([]) }}\"\nconf_shell: \"{{ conf_shell_default|default([]) + conf_shell_custom|default([]) }}\"\nconf_sysrc: \"{{ conf_sysrc_default|default([]) + conf_sysrc_custom|default([]) }}\"\n</code></pre>"},{"location":"usage/#step-3-add-host-specific-customizations-in-host_vars","title":"Step 3: Add host-specific customizations in host_vars","text":"<p>Override <code>_custom</code> in a host's vars file to add host-specific configurations on top of the defaults:</p> <pre><code># host_vars/db-01.example\n\nconf_lineinfile_custom:\n  - service: bsnmpd\n    regexp: 'location := .*'\n    line: 'location := \"Datacenter A, Rack 4\"'\n    state: present\n    path: /etc/snmpd.config\n  - service: bsnmpd\n    regexp: 'contact := .*'\n    line: 'contact := \"ops@example.com\"'\n    state: present\n    path: /etc/snmpd.config\nconf_lineinfile: \"{{ conf_lineinfile_default|default([]) + conf_lineinfile_custom|default([]) }}\"\n\nconf_copy_custom:\n  - service: ''\n    content: |\n      10.0.0.5    db-01 db-01.example\n      10.0.0.6    db-02 db-02.example\n    group: wheel\n    mode: '0644'\n    dest: /etc/hosts\n  - service: devfs\n    content: |\n      [localrules=10]\n      add path fuse mode 0666\n    group: wheel\n    mode: '0644'\n    dest: /etc/devfs.rules\nconf_copy: \"{{ conf_copy_default|default([]) + conf_copy_custom|default([]) }}\"\n\nconf_sysrc_custom:\n  - name: zfs_enable\n    value: \"YES\"\n    state: present\n    path: /etc/rc.conf\n  - name: devfs_system_ruleset\n    value: \"localrules\"\n    state: present\n    path: /etc/rc.conf\nconf_sysrc: \"{{ conf_sysrc_default|default([]) + conf_sysrc_custom|default([]) }}\"\n</code></pre> <p>When the playbook runs on <code>db-01.example</code>, it gets both the shared SSH hardening from defaults and the host-specific SNMP, hosts file, and sysrc entries from custom.</p>"},{"location":"usage/#step-4-playbook-tasks-loop-over-the-merged-variable","title":"Step 4: Playbook tasks loop over the merged variable","text":"<p>The playbook only references the final <code>conf_*</code> variable \u2014 it doesn't need to know about the default/custom split:</p> <pre><code>- name: lineinfile\n  ansible.builtin.lineinfile:\n    regexp: '{{ item.regexp }}'\n    line: '{{ item.line }}'\n    path: '{{ item.path }}'\n    state: '{{ item.state | default(\"present\") }}'\n  loop: '{{ conf_lineinfile | default([]) }}'\n  register: conf_lineinfile_changed\n  tags: [ 'post', 'lineinfile' ]\n\n- name: copy\n  ansible.builtin.copy:\n    content: '{{ item.content }}'\n    dest: '{{ item.dest }}'\n    group: '{{ item.group }}'\n    mode: '{{ item.mode }}'\n  loop: '{{ conf_copy | default([]) }}'\n  register: conf_copy_changed\n  tags: [ 'post', 'copy' ]\n\n- name: blockinfile\n  ansible.builtin.blockinfile:\n    block: '{{ item.block }}'\n    path: '{{ item.path }}'\n  loop: '{{ conf_blockinfile | default([]) }}'\n  register: conf_blockinfile_changed\n  tags: [ 'post', 'blockinfile' ]\n\n- name: file\n  ansible.builtin.file:\n    dest: '{{ item.dest }}'\n    state: '{{ item.state }}'\n    owner: '{{ item.owner | default(\"root\") }}'\n    group: '{{ item.group | default(\"wheel\") }}'\n    mode: '{{ item.mode | default(\"0755\") }}'\n  loop: '{{ conf_file | default([]) }}'\n  tags: [ 'post', 'file' ]\n\n- name: get_url\n  ansible.builtin.get_url:\n    url: '{{ item.url }}'\n    dest: '{{ item.dest }}'\n    owner: '{{ item.owner | default(\"root\") }}'\n    group: '{{ item.group }}'\n    mode: '{{ item.mode }}'\n  loop: '{{ conf_get_url | default([]) }}'\n  tags: [ 'post', 'get_url' ]\n\n- name: sysrc\n  community.general.sysrc:\n    name: '{{ item.name }}'\n    value: '{{ item.value }}'\n    state: '{{ item.state }}'\n    path: '{{ item.path | default(\"/etc/rc.conf\") }}'\n  loop: '{{ conf_sysrc | default([]) }}'\n  when: ansible_os_family == \"FreeBSD\"\n  tags: [ 'post', 'sysrc' ]\n</code></pre>"},{"location":"usage/#automatic-service-restart-on-config-change","title":"Automatic service restart on config change","text":"<p>Each <code>conf_*</code> item can include a <code>service</code> field. When the task registers a change, the playbook collects affected services and restarts them automatically:</p> <pre><code>- name: Collect services to restart (copy)\n  set_fact:\n    services_to_restart_copy: \"{{ services_to_restart_copy | default([]) + [item.service] }}\"\n  loop: \"{{ conf_copy }}\"\n  when: conf_copy_changed.changed and item.service is defined and item.service != \"\"\n\n- name: Restart services (copy)\n  ansible.builtin.service:\n    name: \"{{ item }}\"\n    state: restarted\n  loop: \"{{ services_to_restart_copy | unique }}\"\n  when: conf_copy_changed.changed | bool\n</code></pre> <p>Items can also include a <code>command</code> field for post-change commands instead of (or in addition to) service restarts:</p> <pre><code>- name: Collect commands to exec (copy)\n  set_fact:\n    commands_to_exec_copy: \"{{ commands_to_exec_copy | default([]) + [item.command] }}\"\n  loop: \"{{ conf_copy }}\"\n  when: conf_copy_changed.changed and item.command is defined and item.command != \"\"\n</code></pre>"},{"location":"usage/#item-structure-reference","title":"Item structure reference","text":"<p>Each <code>conf_*</code> type has a specific item structure:</p> <p>conf_copy:</p> <pre><code>- service: 'nginx'              # Service to restart on change (empty string = none)\n  command: '/usr/local/bin/reload-app'  # Command to run on change (optional)\n  content: |                    # Inline file content\n    server_name example.com;\n  dest: '/etc/nginx/conf.d/app.conf'\n  group: 'wheel'\n  mode: '0644'\n  owner: 'root'                 # Optional, defaults to root\n  validate: 'nginx -t -c %s'   # Optional validation command\n</code></pre> <p>conf_lineinfile:</p> <pre><code>- service: 'sshd'\n  regexp: '^PermitRootLogin'\n  line: 'PermitRootLogin prohibit-password'\n  state: 'present'              # present or absent\n  path: '/etc/ssh/sshd_config'\n  insertbefore: '#LoginGraceTime'  # Optional insertion point\n  validate: '/usr/sbin/sshd -t -f %s'\n</code></pre> <p>conf_blockinfile:</p> <pre><code>- service: 'pf'\n  command: 'pfctl -f /etc/pf.conf'\n  block: |\n    pass in on egress proto tcp to port { 80, 443 }\n    pass out all\n  path: '/etc/pf.conf'\n  state: 'present'\n</code></pre> <p>conf_file:</p> <pre><code>- dest: '/var/data/backups'\n  state: 'directory'            # file, directory, link, absent\n  recurse: true\n  owner: 'backup'\n  group: 'wheel'\n  mode: '0750'\n</code></pre> <p>conf_get_url:</p> <pre><code>- url: 'https://example.com/scripts/monitor.sh'\n  dest: '/usr/local/bin/monitor.sh'\n  owner: 'root'\n  group: 'wheel'\n  mode: '0755'\n</code></pre> <p>conf_sysrc (FreeBSD):</p> <pre><code>- name: 'nginx_enable'\n  value: 'YES'\n  state: 'present'\n  path: '/etc/rc.conf'\n</code></pre> <p>conf_shell:</p> <pre><code>- cmd: 'zpool scrub tank'\n  creates: '/var/log/scrub.done'  # Optional, skip if file exists\n</code></pre>"},{"location":"usage/#pre-tasks-and-post-tasks","title":"Pre-tasks and post-tasks","text":"<p>Run tasks before and after roles:</p> <pre><code>---\n- hosts: all\n  become: true\n  gather_facts: true\n\n  pre_tasks:\n    - name: Update apt cache\n      ansible.builtin.apt:\n        update_cache: true\n        cache_valid_time: 3600\n      when: ansible_os_family == \"Debian\"\n      tags: packages\n\n  roles:\n    - role: packages\n      tags: packages\n    - role: users\n      tags: users\n\n  post_tasks:\n    - name: Reboot if required\n      ansible.builtin.reboot:\n      when: reboot_required | default(false)\n      tags: reboot\n</code></pre>"},{"location":"usage/#importing-secondary-playbooks","title":"Importing secondary playbooks","text":"<p>Split large playbooks into multiple files:</p> <pre><code>---\n- import_playbook: playbook-base.yml\n- import_playbook: playbook-docker.yml\n- import_playbook: playbook-monitoring.yml\n</code></pre>"},{"location":"usage/#variable-hierarchy","title":"Variable Hierarchy","text":"<p>Ansible merges variables in a defined order. With flamelet tenants, a typical hierarchy is:</p> <pre><code>group_vars/all        # Defaults for every host\ngroup_vars/&lt;os&gt;       # OS-specific overrides (debian, freebsd, openbsd)\ngroup_vars/&lt;function&gt; # Function-specific overrides (docker, k3s, monitoring)\nhost_vars/&lt;host&gt;      # Per-host overrides\n</code></pre>"},{"location":"usage/#composable-defaults","title":"Composable defaults","text":"<p>Define a base list in <code>group_vars/all</code> and extend it in more specific groups:</p> <p><code>group_vars/all</code>:</p> <pre><code>package_install_default:\n  - tree\n  - curl\n  - git\n  - rsync\n  - tmux\n\npackage_install: \"{{ package_install_default }}\"\n</code></pre> <p><code>group_vars/docker</code>:</p> <pre><code>package_install: \"{{ package_install_default + ['docker.io', 'docker-compose'] }}\"\n</code></pre> <p><code>group_vars/monitoring</code>:</p> <pre><code>package_install: \"{{ package_install_default + ['prometheus-node-exporter'] }}\"\n</code></pre> <p>This way, every host gets the base packages, and specific groups add their own on top.</p>"},{"location":"usage/#tag-based-deployment","title":"Tag-Based Deployment","text":"<p>Tags let you run only specific parts of a playbook. Pass them through flamelet with <code>-o</code>:</p>"},{"location":"usage/#run-by-role","title":"Run by role","text":"<pre><code># Only run the packages role\nflamelet -t myproject -l ansible -o \"--tags packages\"\n\n# Run packages and users\nflamelet -t myproject -l ansible -o \"--tags packages,users\"\n</code></pre>"},{"location":"usage/#run-by-action","title":"Run by action","text":"<p>If your tasks use fine-grained tags like <code>lineinfile</code>, <code>copy</code>, or <code>cron</code>:</p> <pre><code># Only apply lineinfile and copy changes\nflamelet -t myproject -l ansible -o \"--tags lineinfile,copy\"\n</code></pre>"},{"location":"usage/#limit-by-group","title":"Limit by group","text":"<pre><code># Run on debian hosts only\nflamelet -t myproject -l ansible -o \"--limit debian\"\n\n# Run on freebsd hosts, excluding jails\nflamelet -t myproject -l ansible -o \"--limit freebsd,!jails\"\n</code></pre>"},{"location":"usage/#limit-by-host","title":"Limit by host","text":"<pre><code># Run on a single host\nflamelet -t myproject -l ansible -o \"--limit web-01.example\"\n</code></pre>"},{"location":"usage/#combine-tags-and-limits","title":"Combine tags and limits","text":"<pre><code># Run only the users role on debian hosts\nflamelet -t myproject -l ansible -o \"--tags users --limit debian\"\n</code></pre>"},{"location":"usage/#ansiblecfg-recommended-settings","title":"ansible.cfg Recommended Settings","text":"<p>Place an <code>ansible.cfg</code> in your tenant directory and point <code>CFG_ANSIBLE_CONFIG</code> to it.</p> <pre><code>[defaults]\n# Use YAML callback for readable output\nstdout_callback = yaml\n\n# Use debug callback for detailed error output\n# stdout_callback = debug\n\n# Silence Python interpreter auto-detection warnings\ninterpreter_python = auto_silent\n\n# Retry files clutter the directory\nretry_files_enabled = False\n\n# Increase parallelism\nforks = 20\n\n[ssh_connection]\n# Forward SSH agent for git clones on remote hosts\nssh_args = -o ForwardAgent=yes -o ControlMaster=auto -o ControlPersist=60s\n\n# Use SCP for file transfers (more compatible than SFTP)\ntransfer_method = scp\n\n# Pipeline for faster execution\npipelining = True\n</code></pre>"}]}